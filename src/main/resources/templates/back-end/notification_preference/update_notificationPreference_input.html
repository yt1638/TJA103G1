<div th:fragment="content">
  <style>
    .page-title{
      font-size: 30px;
      font-weight: 800;
      color:#2f3b4a;
      margin: 10px 0 18px;
    }

    .tag-title{
      display:inline-flex;
      align-items:center;
      gap:10px;
      background:#e5e5e5;
      color:#6b6b6b;
      font-weight:700;
      padding:14px 16px;
      border-radius:4px;
      min-width:260px;
    }

    .btn-black{
      background:#111;
      color:#fff;
      border:1px solid #111;
      padding:12px 16px;
      border-radius:4px;
      font-weight:700;
    }
    .btn-black:hover{ filter:brightness(.95); }

    .msg-box{
      margin-top:10px;
      border:1px solid #d9d9d9;
      border-radius:5px;
      background:#fff;
      padding:0;
    }
    .msg-textarea{
      width:100%;
      min-height:150px;
      border:0;
      outline:0;
      resize: vertical;
      padding:14px 14px;
      font-size:18px;
      line-height:1.7;
      color:#2f3b4a;
    }
    .msg-textarea::placeholder{
      color:#9aa4b2;
      font-weight:600;
    }

    /* 下方左右兩欄灰區塊（比照附件） */
    .schedule-box{
      margin-top:16px;
      background:#ededed;
      border-radius:12px;
      padding:18px 22px;
      max-width:900px;
      display:flex;
      gap:40px;
    }
    .schedule-col{
      flex:1 1 0;
    }
    .schedule-title{
      font-weight:700;
      color:#7a7a7a;
      margin-bottom:12px;
      font-size:16px;
    }
    .schedule-row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .schedule-row select,
	.schedule-row input{
	  min-width:220px;   /* 跟會員信箱一樣寬 */
	  height:44px;
	  border:1px solid #cfcfcf;
	  border-radius:6px;
	  padding:0 12px;
	  background:#fff;
	  font-size:16px;
	  color:#4b5563;
	  font-weight:700;
	}
    .unit{
      font-weight:900;
      color:#7a7a7a;
      font-size:18px;
    }

    .error{
      color:#d60000;
      font-weight:800;
      margin-top:8px;
      display:block;
    }

    .btn-black-sm{
      background:#111;
      color:#fff;
      border:1px solid #111;
      padding:8px 14px;
      border-radius:4px;
      font-weight:700;
      font-size:14px;
    }
    .btn-black-sm:hover{ filter:brightness(.95); }

    /* 顯示後端 flash 訊息（比照附件） */
    .flash{
      max-width: 900px;
      margin: 10px 0 0;
      padding: 12px 14px;
      border-radius: 8px;
      font-weight: 800;
    }
    .flash-ok{
      background:#e9fff0;
      border:1px solid #b7f0c7;
      color:#146c2e;
    }
    .flash-err{
      background:#fff0f0;
      border:1px solid #f3bcbc;
      color:#a40000;
    }
  </style>

  <div class="container-fluid">

    <div class="page-title">喜好通知編輯</div>

    <!-- ✅ flash message（請你後端用 RedirectAttributes / model 丟 success / error） -->
    <div th:if="${success}" class="flash flash-ok" th:text="${success}"></div>
    <div th:if="${error}"   class="flash flash-err" th:text="${error}"></div>

    <form id="prefForm"
          th:action="@{/notification_preference/update}"
          method="post"
          th:object="${notificationPreferenceVO}">

      <!-- hidden 欄位：仍會送出給後端（依你 VO 結構調整） -->
      <input type="hidden" th:field="*{member.memberId}" id="memberIdHidden">
      <input type="hidden" th:field="*{member.memberId}">

      <!-- 灰色標籤 + 右上立即發送 -->
      <div class="d-flex align-items-center justify-content-between" style="gap:12px;">
        <div class="tag-title">
          <span>喜好通知:</span>
          <i class="fas fa-pen"></i>
        </div>

        <!-- ✅ 立即發送：mode=sendNow（後端依 mode 判斷寄信 / 更新） -->
        <button class="btn-black" type="submit" name="mode" value="sendNow">立即發送</button>
      </div>

      <!-- 內容（大 textarea） -->
      <div class="msg-box">
        <textarea class="msg-textarea"
                  th:field="*{notiPrefScon}"
                  placeholder="親愛的用戶您好：&#10;此封訊息為依據您的喜好，所發送推薦電影..."
                  onclick="hideContent('notiPrefScon.errors');"></textarea>
      </div>

      <span th:if="${#fields.hasErrors('notiPrefScon')}"
            th:errors="*{notiPrefScon}"
            class="error"
            id="notiPrefScon.errors"></span>

      <!-- 下方灰色左右兩欄 -->
      <div class="schedule-box">

        <!-- 左欄：預先發送時間（天） -->
        <div class="schedule-col">
          <div class="schedule-title">設定預先發送時間:</div>

          <div class="schedule-row">
            <select name="advanceDays">
              <option value="" selected>請選擇天數</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="5">5</option>
              <option value="7">7</option>
            </select>

            <span class="unit">天</span>

            <!-- ✅ 跟附件一致：mode=schedule -->
            <button class="btn-black-sm" type="submit" name="mode" value="schedule">確認</button>
          </div>
        </div>

        <!-- 右欄：選擇會員信箱 -->
        <div class="schedule-col">
          <div class="schedule-title">選擇會員信箱:</div>

          <div class="schedule-row">
            <!-- ✅ 跟附件一致用 toEmail（你後端要接這個參數） -->
            <select name="toEmail" id="toEmailSelect" onchange="syncMemberId()">
			  <option value="">請選擇會員信箱</option>
			  <option th:each="m : ${memberList}"
			          th:value="${m.email}"
			          th:text="${m.email}"
			          th:attr="data-memberid=${m.memberId}">
			  </option>
			</select>
			
			<input type="number"
			       name="movieId"
			       placeholder="請輸入電影編號"
			       min="1"
			       required>

            <!-- ✅ 比照附件：右欄確認也走 sendNow（最穩） -->
            <button class="btn-black-sm" type="button" onclick="syncMemberId(); alert('已選擇時間，若要立即寄送請按右上「立即發送」，若要排程請在左欄選小時後按左欄「確認」。');">
            確認</button>
          </div>
        </div>

      </div>
    </form>
  </div>

  <script>
  function syncMemberId(){
    const sel = document.getElementById("toEmailSelect");
    const opt = sel.options[sel.selectedIndex];
    const memberId = opt.getAttribute("data-memberid") || "";
    document.getElementById("memberIdHidden").value = memberId;
  }

  // 頁面初次載入時如果已有選擇，也同步一次
  document.addEventListener("DOMContentLoaded", syncMemberId);

  function hideContent(id){
    const el = document.getElementById(id);
    if(el) el.style.display = "none";
  }
</script>

</div>
